<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart QR Attendance (Offline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e3f2fd, #e0f2f1 40%, #f5f5f5 80%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .card {
      width: 100%;
      max-width: 520px;
      background: rgba(255,255,255,0.96);
      border-radius: 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
      overflow: hidden;
      animation: floatIn 0.5s ease-out;
    }

    @keyframes floatIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .card-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, #1976d2, #00bfa5);
      color: white;
    }

    .card-header h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .card-subtitle {
      font-size: 0.8rem;
      opacity: 0.85;
      margin-top: 4px;
    }

    .card-body { padding: 18px 20px 20px; }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-top: 6px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    button.primary {
      background: linear-gradient(135deg, #1976d2, #00b0ff);
      color: white;
      box-shadow: 0 6px 18px rgba(25,118,210,0.4);
    }

    button.secondary {
      background: #eceff1;
      color: #37474f;
    }

    button.danger {
      background: #ef5350;
      color: white;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
      opacity: 0.9;
    }

    .status { font-size: 0.8rem; min-height: 20px; margin-top: 6px; }
    .status.error { color: #c62828; }
    .status.ok { color: #2e7d32; }

    .tabs { display:flex; gap:6px; margin-bottom:10px; }
    .tab-btn {
      flex:1; padding:6px; border-radius:999px; border:none; cursor:pointer;
      background:#eceff1; font-size:0.8rem; color:#455a64;
    }
    .tab-btn.active {
      background:#1976d2; color:white;
      box-shadow:0 4px 10px rgba(25,118,210,0.4);
    }

    .hidden { display:none !important; }

    #reader {
      margin-top: 10px;
      border-radius: 14px;
      overflow: hidden;
      background: #000;
    }

    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:0.8rem;
      background:white;
    }
    th,td { padding:6px 4px; border-bottom:1px solid #eceff1; text-align:left; }
    th { background:#eceff1; }
    tbody tr:nth-child(even) { background:#f9f9f9; }

    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.72rem;
      background:#e3f2fd;
      color:#1976d2;
      font-weight:600;
    }

    .settings-grid {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:6px;
      margin-top:6px;
    }

    label {
      font-size:0.78rem;
      color:#455a64;
      display:block;
      margin-bottom:2px;
    }

    input.small-input {
      width:100%;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #cfd8dc;
      font-size:0.8rem;
    }

    input.small-input:focus {
      border-color:#1976d2;
      box-shadow:0 0 0 2px rgba(25,118,210,0.2);
      outline:none;
    }

    @media (max-width:480px){
      .card { border-radius:16px; }
      .card-header h1 { font-size:1.15rem; }
    }
  </style>
</head>

<body>

<div class="card">
  <div class="card-header">
    <h1>Smart QR Attendance</h1>
    <div class="card-subtitle">
      Offline â€“ data stored in this browser. <span id="todayLabel" class="pill"></span>
    </div>
  </div>

  <div class="card-body">

    <div class="tabs">
      <button id="tabScan" class="tab-btn active" onclick="showTab('scan')">Scan &amp; Mark</button>
      <button id="tabReport" class="tab-btn" onclick="showTab('report')">Monthly Report</button>
    </div>

    <!-- SCAN TAB -->
    <div id="scanTab">
      <button class="primary" onclick="startScan()">ðŸ“· Scan QR</button>
      <button class="secondary" onclick="stopScan()">âœ– Stop Scanner</button>
      <div id="scanStatus" class="status"></div>

      <div id="reader" class="hidden"></div>

      <table id="todayTable">
        <thead>
          <tr><th>Name</th><th>IN</th><th>OUT</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <button class="secondary" onclick="exportCSV()">â¬‡ Download All Data (CSV)</button>
      <button class="danger" onclick="clearToday()">Clear Today (only)</button>
    </div>

    <!-- REPORT TAB -->
    <div id="reportTab" class="hidden">
      <div class="settings-grid">
        <div>
          <label>Year</label>
          <input id="yearInput" type="number" class="small-input">
        </div>
        <div>
          <label>Month (1-12)</label>
          <input id="monthInput" type="number" class="small-input" min="1" max="12">
        </div>
        <div>
          <label>Shift Start (HH:MM)</label>
          <input id="shiftInput" type="time" class="small-input" value="09:00">
        </div>
        <div>
          <label>Grace Minutes</label>
          <input id="graceInput" type="number" class="small-input" value="15" min="0">
        </div>
        <div>
          <label>Late days â†’ Â½ day</label>
          <input id="lateLimitInput" type="number" class="small-input" value="3" min="1">
        </div>
      </div>

      <button class="primary" onclick="generateReport()">Generate Report</button>
      <div id="reportStatus" class="status"></div>

      <table id="reportTable">
        <thead>
          <tr><th>Name</th><th>Present days</th><th>Late days</th><th>Half-day penalty</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
</div>

<script>
  const STORAGE_KEY = "smartAttendanceSessionsV1";

  let sessions = [];          // all completed sessions {name,date,in,out}
  let openSessions = {};      // name -> {date,in}
  let qrScanner = null;

  // ===== INIT =====
  function init() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try { sessions = JSON.parse(saved); } catch(e) { sessions = []; }
    }

    const now = new Date();
    const opts = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
    document.getElementById('todayLabel').textContent =
      now.toLocaleDateString('en-GB', opts);

    document.getElementById('yearInput').value = now.getFullYear();
    document.getElementById('monthInput').value = now.getMonth() + 1;

    refreshTodayTable();
  }

  // ===== TAB SWITCH =====
  function showTab(tab) {
    document.getElementById('scanTab').classList.toggle('hidden', tab !== 'scan');
    document.getElementById('reportTab').classList.toggle('hidden', tab !== 'report');
    document.getElementById('tabScan').classList.toggle('active', tab === 'scan');
    document.getElementById('tabReport').classList.toggle('active', tab === 'report');
    if (tab === 'report') stopScan();
  }

  // ===== QR SCANNING =====
  function startScan() {
    const readerDiv = document.getElementById('reader');
    const status = document.getElementById('scanStatus');
    readerDiv.classList.remove('hidden');
    status.textContent = 'Opening camera...';

    if (qrScanner) {
      qrScanner.clear().catch(()=>{});
      qrScanner = null;
    }

    qrScanner = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    qrScanner.start(
      { facingMode: "environment" },
      config,
      decodedText => {
        status.textContent = 'Scanned: ' + decodedText;
        markAttendance(decodedText.trim());
      },
      () => {}
    ).catch(err => {
      console.error(err);
      status.textContent = 'Camera error: ' + err;
      readerDiv.classList.add('hidden');
    });
  }

  function stopScan() {
    const readerDiv = document.getElementById('reader');
    if (qrScanner) {
      qrScanner.stop().catch(()=>{});
      qrScanner.clear().catch(()=>{});
      qrScanner = null;
    }
    readerDiv.classList.add('hidden');
    document.getElementById('scanStatus').textContent = '';
  }

  // ===== ATTENDANCE LOGIC =====
  function markAttendance(name) {
    if (!name) return;

    const now = new Date();
    const dateStr = now.toISOString().slice(0,10);
    const timeStr = now.toTimeString().slice(0,5);

    const key = name + "|" + dateStr;

    if (!openSessions[key]) {
      // IN
      openSessions[key] = { name, date: dateStr, in: timeStr };
    } else {
      // OUT â†’ complete session
      const rec = {
        name,
        date: dateStr,
        in: openSessions[key].in,
        out: timeStr
      };
      sessions.push(rec);
      delete openSessions[key];
      saveSessions();
    }

    refreshTodayTable();
  }

  function refreshTodayTable() {
    const tbody = document.querySelector('#todayTable tbody');
    tbody.innerHTML = "";
    const today = new Date().toISOString().slice(0,10);

    // Show completed sessions for today
    const todaySessions = sessions.filter(s => s.date === today);
    todaySessions.forEach(rec => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${rec.name}</td><td>${rec.in}</td><td>${rec.out}</td>`;
      tbody.appendChild(tr);
    });

    // Show open sessions as rows with blank OUT
    Object.values(openSessions).forEach(rec => {
      if (rec.date === today) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${rec.name}</td><td>${rec.in}</td><td>â€”</td>`;
        tbody.appendChild(tr);
      }
    });
  }

  function saveSessions() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
  }

  function clearToday() {
    if (!confirm("Clear only today's records on this device?")) return;
    const today = new Date().toISOString().slice(0,10);
    sessions = sessions.filter(s => s.date !== today);
    Object.keys(openSessions).forEach(k => {
      if (openSessions[k].date === today) delete openSessions[k];
    });
    saveSessions();
    refreshTodayTable();
  }

  // ===== CSV EXPORT =====
  function exportCSV() {
    if (!sessions.length) {
      alert("No completed records to export.");
      return;
    }
    const header = ["Name","Date","In Time","Out Time","Duration (hrs)"];
    const rows = [header];

    sessions.forEach(rec => {
      const dur = calcDuration(rec.in, rec.out);
      rows.push([rec.name, rec.date, rec.in, rec.out, dur.toFixed(2)]);
    });

    const csv = rows.map(r => r.map(x => `"${x}"`).join(",")).join("\r\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = "attendance_data.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function calcDuration(inTime, outTime) {
    if (!inTime || !outTime) return 0;
    const [ih,im] = inTime.split(":").map(Number);
    const [oh,om] = outTime.split(":").map(Number);
    let mins = (oh*60+om) - (ih*60+im);
    if (mins < 0) mins = 0;
    return mins / 60;
  }

  // ===== MONTHLY REPORT =====
  function generateReport() {
    const year = Number(document.getElementById('yearInput').value);
    const month = Number(document.getElementById('monthInput').value);
    const shift = document.getElementById('shiftInput').value || "09:00";
    const grace = Number(document.getElementById('graceInput').value || 0);
    const lateLimit = Number(document.getElementById('lateLimitInput').value || 3);
    const status = document.getElementById('reportStatus');

    status.textContent = "Calculating...";
    const prefix = year + "-" + String(month).padStart(2,"0");

    const monthRecs = sessions.filter(r => r.date.startsWith(prefix));
    const summary = buildMonthlySummary(monthRecs, shift, grace, lateLimit);

    const tbody = document.querySelector('#reportTable tbody');
    tbody.innerHTML = "";
    Object.keys(summary).forEach(name => {
      const s = summary[name];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${name}</td><td>${s.present}</td><td>${s.late}</td><td>${s.half}</td>`;
      tbody.appendChild(tr);
    });

    status.textContent = `Report ready for ${Object.keys(summary).length} employees.`;
  }

  function buildMonthlySummary(records, shiftStart, graceMinutes, lateLimit) {
    const empDayMap = {}; // name -> date -> earliestIn
    const [sh,sm] = shiftStart.split(":").map(Number);
    const shiftMin = sh*60 + sm;
    const grace = Number(graceMinutes||0);

    records.forEach(r => {
      const name = r.name;
      const date = r.date;
      const inTime = r.in;
      if (!name || !date || !inTime) return;
      const [h,m] = inTime.split(":").map(Number);
      const mins = h*60 + m;

      if (!empDayMap[name]) empDayMap[name] = {};
      if (!empDayMap[name][date] || mins < empDayMap[name][date]) {
        empDayMap[name][date] = mins;
      }
    });

    const out = {};
    Object.keys(empDayMap).forEach(name => {
      const days = Object.keys(empDayMap[name]);
      let late = 0;
      days.forEach(d => {
        if (empDayMap[name][d] > shiftMin + grace) late++;
      });
      out[name] = {
        present: days.length,
        late: late,
        half: late >= lateLimit ? 0.5 : 0
      };
    });

    return out;
  }

  // ===== START =====
  init();
</script>
</body>
</html>
